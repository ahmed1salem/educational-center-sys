<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
    
    <style>
        body { background-color: #f8f9fa; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #343a40; display: flex; justify-content: center; align-items: center; z-index: 9999; }
        #login-box { background: white; padding: 2rem; border-radius: 0.5rem; width: 100%; max-width: 400px; }
        #app-wrapper { display: none; }
        .main-content .page { display: none; }
        .main-content .page.active { display: block; }
        .sidebar { height: 100vh; position: sticky; top: 0; background-color: #343a40; color: white; overflow-y: auto; }
        .sidebar .nav-link { color: #adb5bd; cursor: pointer; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: white; background-color: #495057; }
        .stat-card { border: none; border-radius: 0.5rem; color: white; }
        .card-icon { font-size: 3rem; opacity: 0.7; }
        #receipt-modal-content { font-family: 'Courier New', Courier, monospace; text-align: center; }
        .table-responsive { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>

<div id="login-screen">
    <div id="login-box" class="text-center">
        <h3 class="mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
        <form id="login-form">
            <div class="form-floating mb-3"><input type="text" class="form-control" id="username" placeholder="Username" required><label for="username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label></div>
            <div class="form-floating mb-3"><input type="password" class="form-control" id="password" placeholder="Password" required><label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label></div>
            <button type="submit" class="btn btn-primary w-100">Ø¯Ø®ÙˆÙ„</button>
            <div id="login-error" class="text-danger mt-2" style="display: none;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.</div>
        </form>
    </div>
</div>

<div id="app-wrapper">
    <div class="container-fluid">
        <div class="row">
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar p-3">
                <h4 class="text-center mb-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²</h4>
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link active" onclick="showPage('dashboard')">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showPage('teachers')">ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¯Ø±Ø³ÙˆÙ†</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showPage('groups')">ğŸ“š Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙˆØ§Ù„Ø­ØµØµ</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showPage('students')">ğŸ§‘â€ğŸ“ Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showPage('attendance')">âœ… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showPage('grades')">ğŸ“ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showPage('finance')">ğŸ’µ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</a></li>
                    <li class="nav-item"><a class="nav-link text-warning" onclick="logout()">ğŸ”’ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
                    <li class="nav-item"><a class="nav-link text-danger" onclick="clearData()">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</a></li>
                </ul>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 pt-4 main-content">
                
                <div id="dashboard" class="page active">
                    </div>
                
                <div id="teachers" class="page">
                    </div>

                <div id="groups" class="page">
                    </div>

                <div id="students" class="page">
                    </div>

                <div id="attendance" class="page">
                    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</h3>
                     <div class="card p-3 mb-4">
                        <h5>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø¬Ø¯ÙŠØ¯</h5>
                        <p>Ù‚Ù… Ø¨ØªÙˆØ¬ÙŠÙ‡ Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù†Ø­Ùˆ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø¯Ù†Ø§Ù‡.</p>
                        <input type="text" id="barcode-input" class="form-control form-control-lg" placeholder="ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯...">
                        <div id="attendance-feedback" class="mt-3"></div>
                    </div>

                    <div class="card p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h5>
                            <div>
                                <label for="attendance-date-filter" class="form-label">Ø¹Ø±Ø¶ Ø³Ø¬Ù„ ØªØ§Ø±ÙŠØ®:</label>
                                <input type="date" id="attendance-date-filter" class="form-control">
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                        <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th>Ø§Ù„ÙˆÙ‚Øª</th>
                                    </tr>
                                </thead>
                                <tbody id="attendance-log-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="grades" class="page">
                    </div>

                <div id="finance" class="page">
                    </div>
            </main>
        </div>
    </div>
</div>

<div class="modal fade" id="receiptModal" tabindex="-1">...</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ===== CONFIGURATION =====
const CORRECT_USERNAME = 'admin';
const CORRECT_PASSWORD = '123';

// ===== AUTH LOGIC =====
function handleLogin(e) { e.preventDefault(); if (document.getElementById('username').value === CORRECT_USERNAME && document.getElementById('password').value === CORRECT_PASSWORD) { sessionStorage.setItem('isLoggedIn', 'true'); checkLogin(); } else { document.getElementById('login-error').style.display = 'block'; } }
function logout() { sessionStorage.removeItem('isLoggedIn'); location.reload(); }
function checkLogin() { if (sessionStorage.getItem('isLoggedIn') === 'true') { document.getElementById('login-screen').style.display = 'none'; document.getElementById('app-wrapper').style.display = 'block'; initialize_app(); } else { document.getElementById('login-screen').style.display = 'flex'; document.getElementById('app-wrapper').style.display = 'none'; } }

// ===== DATABASE SIMULATION (localStorage) =====
const DB = {
    get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
    save: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
};

// ===== UI LOGIC =====
function showPage(pageId) {
    document.querySelectorAll('.main-content .page').forEach(p => p.style.display = 'none');
    document.getElementById(pageId).style.display = 'block';
    document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
    document.querySelector(`.sidebar .nav-link[onclick="showPage('${pageId}')"]`).classList.add('active');
    
    // Refresh data when showing a page
    if (pageId === 'dashboard') renderDashboard();
    if (pageId === 'teachers') renderTeachersTable();
    if (pageId === 'groups') { populateTeachersDropdown(); renderGroupsTable(); }
    if (pageId === 'students') { populateGroupsDropdown('student-group'); renderStudentsTable(); }
    if (pageId === 'attendance') {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('attendance-date-filter').value = today;
        renderAttendanceLog(today);
    }
    if (pageId === 'grades') { populateGroupsDropdown('exam-group'); document.getElementById('grades-entry-card').style.display = 'none'; }
    if (pageId === 'finance') renderTeacherFinances();
}

// ... (renderDashboard, renderTeachersTable, etc. remain the same) ...

// ===== NEW AND UPDATED FUNCTIONS FOR ATTENDANCE =====

function renderAttendanceLog(dateFilter) {
    const logBody = document.getElementById('attendance-log-body');
    const allLogs = DB.get('attendance');
    const groups = DB.get('groups');
    logBody.innerHTML = '';

    const filteredLogs = allLogs.filter(log => {
        // If no dateFilter is provided, show all. Otherwise, filter by the selected date.
        return !dateFilter || log.timestamp.startsWith(dateFilter);
    });

    // Show newest records first
    filteredLogs.reverse().forEach(log => {
        const studentGroup = groups.find(g => g.id === log.groupId) || { name: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' };
        const date = new Date(log.timestamp);
        const formattedDate = date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
        const formattedTime = date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
        
        logBody.innerHTML += `
            <tr>
                <td>${log.studentName}</td>
                <td>${studentGroup.name}</td>
                <td>${formattedDate}</td>
                <td>${formattedTime}</td>
            </tr>
        `;
    });
}

// ===== DATA HANDLING LOGIC =====
function addData(key, dataObject) {
    const data = DB.get(key);
    data.push(dataObject);
    DB.save(key, data);
    renderDashboard();
}

// ... (addTeacher, addGroup, addStudent, addPayment remain the same) ...

function handleAttendance(e) {
    const barcode = e.target.value.trim();
    if (barcode === '') return;

    const student = DB.get('students').find(s => s.id === barcode);
    const feedbackEl = document.getElementById('attendance-feedback');
    
    if (student) {
        // Create a new attendance record
        const newLogEntry = {
            id: `ATT-${Date.now()}`,
            studentId: student.id,
            studentName: student.name,
            groupId: student.groupId,
            timestamp: new Date().toISOString() // Save with full date and time
        };

        // Add the new record to the attendance log
        const attendanceLog = DB.get('attendance');
        attendanceLog.push(newLogEntry);
        DB.save('attendance', attendanceLog);

        // Provide feedback to the user
        feedbackEl.innerHTML = `<div class="alert alert-success"><strong>Ø­Ø¶ÙˆØ±:</strong> ${student.name}<br><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${new Date(newLogEntry.timestamp).toLocaleTimeString()}</div>`;
        
        // Refresh the log table to show the new entry immediately
        renderAttendanceLog(document.getElementById('attendance-date-filter').value);

    } else {
        feedbackEl.innerHTML = `<div class="alert alert-danger"><strong>Ø®Ø·Ø£:</strong> Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…Ø³Ø¬Ù„.</div>`;
    }

    // Clear the input and feedback after a few seconds
    setTimeout(() => { 
        e.target.value = ''; 
        feedbackEl.innerHTML = ''; 
    }, 3000);
}

// ... (startGradesEntry, saveGrades, deleteData, etc. remain the same) ...

// ===== APP INITIALIZATION =====
function initialize_app() {
    showPage('dashboard');
    document.getElementById('add-teacher-form').addEventListener('submit', addTeacher);
    document.getElementById('add-group-form').addEventListener('submit', addGroup);
    document.getElementById('add-student-form').addEventListener('submit', addStudent);
    document.getElementById('search-student').addEventListener('keyup', (e) => renderStudentsTable(e.target.value));
    
    // Updated attendance listeners
    document.getElementById('barcode-input').addEventListener('change', handleAttendance);
    document.getElementById('attendance-date-filter').addEventListener('change', (e) => renderAttendanceLog(e.target.value));
    
    document.getElementById('add-payment-form').addEventListener('submit', addPayment);
    document.getElementById('add-exam-form').addEventListener('submit', startGradesEntry);
    document.getElementById('save-grades-btn').addEventListener('click', saveGrades);
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('login-form').addEventListener('submit', handleLogin);
    checkLogin();
});
</script>

</body>
</html>
