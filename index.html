<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
    
    <!-- Custom CSS -->
    <style>
        body { background-color: #f8f9fa; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #343a40; display: flex; justify-content: center; align-items: center; z-index: 9999; }
        #login-box { background: white; padding: 2rem; border-radius: 0.5rem; width: 100%; max-width: 400px; }
        #app-wrapper { display: none; }
        .main-content .page { display: none; }
        .main-content .page.active { display: block; }
        .sidebar { height: 100vh; position: sticky; top: 0; background-color: #343a40; color: white; overflow-y: auto; }
        .sidebar .nav-link { color: #adb5bd; cursor: pointer; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: white; background-color: #495057; }
        .stat-card { border: none; border-radius: 0.5rem; color: white; }
        .card-icon { font-size: 3rem; opacity: 0.7; }
        #receipt-modal-content { font-family: 'Courier New', Courier, monospace; text-align: center; }
        .table-responsive { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>

<!-- ============== LOGIN SCREEN ============== -->
<div id="login-screen">
    <div id="login-box" class="text-center">
        <h3 class="mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
        <form id="login-form">
            <div class="form-floating mb-3"><input type="text" class="form-control" id="username" placeholder="Username" required><label for="username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label></div>
            <div class="form-floating mb-3"><input type="password" class="form-control" id="password" placeholder="Password" required><label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label></div>
            <button type="submit" class="btn btn-primary w-100">Ø¯Ø®ÙˆÙ„</button>
            <div id="login-error" class="text-danger mt-2" style="display: none;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.</div>
        </form>
    </div>
</div>

<!-- ============== MAIN APPLICATION ============== -->
<div id="app-wrapper">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar Navigation -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar p-3">
                <h4 class="text-center mb-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²</h4>
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link active" onclick="showPage('dashboard')">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showPage('teachers')">ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¯Ø±Ø³ÙˆÙ†</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showPage('groups')">ğŸ“š Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙˆØ§Ù„Ø­ØµØµ</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showPage('students')">ğŸ§‘â€ğŸ“ Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showPage('attendance')">âœ… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showPage('grades')">ğŸ“ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showPage('finance')">ğŸ’µ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</a></li>
                    <li class="nav-item"><a class="nav-link text-warning" onclick="logout()">ğŸ”’ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
                    <li class="nav-item"><a class="nav-link text-danger" onclick="clearData()">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</a></li>
                </ul>
            </nav>

            <!-- Main Content Area -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 pt-4 main-content">
                
                <!-- Page: Dashboard -->
                <div id="dashboard" class="page active">
                    <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
                    <div class="row mt-4">
                        <div class="col-lg-3 col-md-6"><div class="card stat-card bg-primary p-3 mb-3"><div class="d-flex justify-content-between align-items-center"><div><h5>Ø§Ù„Ø·Ù„Ø§Ø¨</h5><h2 id="total-students-stat">0</h2></div><div class="card-icon">ğŸ§‘â€ğŸ“</div></div></div></div>
                        <div class="col-lg-3 col-md-6"><div class="card stat-card bg-info p-3 mb-3"><div class="d-flex justify-content-between align-items-center"><div><h5>Ø§Ù„Ù…Ø¯Ø±Ø³ÙˆÙ†</h5><h2 id="total-teachers-stat">0</h2></div><div class="card-icon">ğŸ‘¨â€ğŸ«</div></div></div></div>
                        <div class="col-lg-3 col-md-6"><div class="card stat-card bg-secondary p-3 mb-3"><div class="d-flex justify-content-between align-items-center"><div><h5>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</h5><h2 id="total-groups-stat">0</h2></div><div class="card-icon">ğŸ“š</div></div></div></div>
                        <div class="col-lg-3 col-md-6"><div class="card stat-card bg-success p-3 mb-3"><div class="d-flex justify-content-between align-items-center"><div><h5>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h5><h2 id="total-revenue-stat">0</h2></div><div class="card-icon">ğŸ’µ</div></div></div></div>
                    </div>
                </div>
                
                <!-- Page: Teachers Management -->
                <div id="teachers" class="page">
                    <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</h3>
                    <div class="card p-3 mb-4"><form id="add-teacher-form" class="row align-items-end"><div class="col-md-5"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³</label><input type="text" id="teacher-name" class="form-control" required></div><div class="col-md-4"><label class="form-label">Ø§Ù„Ù…Ø§Ø¯Ø©</label><input type="text" id="teacher-subject" class="form-control" required></div><div class="col-md-2"><label class="form-label">Ø§Ù„Ù†Ø³Ø¨Ø© (%)</label><input type="number" id="teacher-percentage" class="form-control" required min="0" max="100"></div><div class="col-md-1"><button type="submit" class="btn btn-primary w-100">Ø¥Ø¶Ø§ÙØ©</button></div></form></div>
                    <div class="card p-3"><h5 class="card-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</h5><div class="table-responsive"><table class="table table-striped"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù†Ø³Ø¨Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="teachers-table-body"></tbody></table></div></div>
                </div>

                <!-- Page: Groups Management -->
                <div id="groups" class="page">
                    <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙˆØ§Ù„Ø­ØµØµ</h3>
                    <div class="card p-3 mb-4"><form id="add-group-form" class="row align-items-end"><div class="col-md-4"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label><input type="text" id="group-name" class="form-control" required></div><div class="col-md-3"><label class="form-label">Ø§Ù„Ù…Ø¯Ø±Ø³</label><select id="group-teacher" class="form-select" required></select></div><div class="col-md-4"><label class="form-label">Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</label><input type="text" id="group-schedule" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø¨Øª - Ø§Ø«Ù†ÙŠÙ† (5Ù…)" required></div><div class="col-md-1"><button type="submit" class="btn btn-primary w-100">Ø¥Ù†Ø´Ø§Ø¡</button></div></form></div>
                    <div class="card p-3"><h5 class="card-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</h5><div class="table-responsive"><table class="table table-striped"><thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th><th>Ø§Ù„Ù…Ø¯Ø±Ø³</th><th>Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="groups-table-body"></tbody></table></div></div>
                </div>

                <!-- Page: Students Management -->
                <div id="students" class="page">
                    <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                    <div class="card p-3 mb-4"><form id="add-student-form" class="row align-items-end"><div class="col-md-3"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label><input type="text" id="name" class="form-control" required></div><div class="col-md-3"><label class="form-label">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label><input type="text" id="stage" class="form-control" required></div><div class="col-md-3"><label class="form-label">Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label><input type="tel" id="parentPhone" class="form-control" required></div><div class="col-md-2"><label class="form-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label><select id="student-group" class="form-select" required></select></div><div class="col-md-1"><button type="submit" class="btn btn-primary w-100">Ø¥Ø¶Ø§ÙØ©</button></div></form></div>
                    <div class="card p-3"><h5 class="card-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h5><input type="text" id="search-student" class="form-control mb-3" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..."><div class="table-responsive"><table class="table table-striped"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="students-table-body"></tbody></table></div></div>
                </div>

                <!-- Page: Attendance -->
                <div id="attendance" class="page">
                    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</h3>
                     <div class="card p-3 mb-4">
                        <h5>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø¬Ø¯ÙŠØ¯</h5>
                        <p>Ù‚Ù… Ø¨ØªÙˆØ¬ÙŠÙ‡ Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù†Ø­Ùˆ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø¯Ù†Ø§Ù‡.</p>
                        <input type="text" id="barcode-input" class="form-control form-control-lg" placeholder="ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯...">
                        <div id="attendance-feedback" class="mt-3"></div>
                    </div>

                    <div class="card p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h5>
                            <div>
                                <label for="attendance-date-filter" class="form-label">Ø¹Ø±Ø¶ Ø³Ø¬Ù„ ØªØ§Ø±ÙŠØ®:</label>
                                <input type="date" id="attendance-date-filter" class="form-control">
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                        <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th>Ø§Ù„ÙˆÙ‚Øª</th>
                                    </tr>
                                </thead>
                                <tbody id="attendance-log-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Grades -->
                <div id="grades" class="page">
                    <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª</h3>
                    <div class="card p-3 mb-4"><form id="add-exam-form" class="row align-items-end"><div class="col-md-5"><label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label><select id="exam-group" class="form-select" required></select></div><div class="col-md-5"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</label><input type="text" id="exam-name" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù…ØªØ­Ø§Ù† Ø´Ù‡Ø± Ø£ÙƒØªÙˆØ¨Ø±" required></div><div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Ø¨Ø¯Ø¡ Ø±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</button></div></form></div>
                    <div class="card p-3" id="grades-entry-card" style="display:none;"><h5 id="grades-entry-title"></h5><div class="table-responsive"><table class="table"><thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr></thead><tbody id="grades-entry-body"></tbody></table></div><button class="btn btn-success mt-3" id="save-grades-btn">Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</button></div>
                </div>

                <!-- Page: Finance -->
                <div id="finance" class="page">
                    <h3>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
                    <div class="card p-3 mb-4"><form id="add-payment-form" class="row align-items-end"><div class="col-md-5"><label class="form-label">ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</label><input type="text" class="form-control" id="payment-student-id" required></div><div class="col-md-5"><label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label><input type="number" class="form-control" id="payment-amount" required></div><div class="col-md-2"><button type="submit" class="btn btn-success w-100">ØªØ³Ø¬ÙŠÙ„</button></div></form></div>
                    <div class="card p-3"><h5 class="card-title">Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</h5><div class="table-responsive"><table class="table table-striped"><thead><tr><th>Ø§Ù„Ù…Ø¯Ø±Ø³</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th><th>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¯Ø±Ø³</th><th>Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³</th></tr></thead><tbody id="teacher-finances-table-body"></tbody></table></div></div>
                </div>

            </main>
        </div>
    </div>
</div>

<!-- Receipt Modal -->
<div class="modal fade" id="receiptModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Ø¥ÙŠØµØ§Ù„ Ø§Ø³ØªÙ„Ø§Ù…</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="receipt-modal-content"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button><button type="button" class="btn btn-primary" onclick="printReceipt()">Ø·Ø¨Ø§Ø¹Ø©</button></div></div></div></div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ===== CONFIGURATION =====
const CORRECT_USERNAME = 'admin';
const CORRECT_PASSWORD = '123';

// ===== AUTH LOGIC =====
function handleLogin(e) { e.preventDefault(); if (document.getElementById('username').value === CORRECT_USERNAME && document.getElementById('password').value === CORRECT_PASSWORD) { sessionStorage.setItem('isLoggedIn', 'true'); checkLogin(); } else { document.getElementById('login-error').style.display = 'block'; } }
function logout() { sessionStorage.removeItem('isLoggedIn'); location.reload(); }
function checkLogin() { if (sessionStorage.getItem('isLoggedIn') === 'true') { document.getElementById('login-screen').style.display = 'none'; document.getElementById('app-wrapper').style.display = 'block'; initialize_app(); } else { document.getElementById('login-screen').style.display = 'flex'; document.getElementById('app-wrapper').style.display = 'none'; } }

// ===== DATABASE SIMULATION (localStorage) =====
const DB = {
    get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
    save: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
};

// ===== UI LOGIC =====
function showPage(pageId) {
    document.querySelectorAll('.main-content .page').forEach(p => p.style.display = 'none');
    document.getElementById(pageId).style.display = 'block';
    document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
    document.querySelector(`.sidebar .nav-link[onclick="showPage('${pageId}')"]`).classList.add('active');
    
    if (pageId === 'dashboard') renderDashboard();
    if (pageId === 'teachers') renderTeachersTable();
    if (pageId === 'groups') { populateTeachersDropdown(); renderGroupsTable(); }
    if (pageId === 'students') { populateGroupsDropdown('student-group'); renderStudentsTable(); }
    if (pageId === 'attendance') {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('attendance-date-filter').value = today;
        renderAttendanceLog(today);
    }
    if (pageId === 'grades') { populateGroupsDropdown('exam-group'); document.getElementById('grades-entry-card').style.display = 'none'; }
    if (pageId === 'finance') renderTeacherFinances();
}

function renderDashboard() {
    document.getElementById('total-students-stat').innerText = DB.get('students').length;
    document.getElementById('total-teachers-stat').innerText = DB.get('teachers').length;
    document.getElementById('total-groups-stat').innerText = DB.get('groups').length;
    const totalRevenue = DB.get('payments').reduce((sum, p) => sum + p.amount, 0);
    document.getElementById('total-revenue-stat').innerText = `${totalRevenue} Ø¬`;
}

function renderTeachersTable() {
    const tableBody = document.getElementById('teachers-table-body');
    tableBody.innerHTML = '';
    DB.get('teachers').forEach(t => { tableBody.innerHTML += `<tr><td>${t.name}</td><td>${t.subject}</td><td>${t.percentage}%</td><td><button class="btn btn-danger btn-sm" onclick="deleteData('teachers', '${t.id}')">Ø­Ø°Ù</button></td></tr>`; });
}

function populateTeachersDropdown() {
    const select = document.getElementById('group-teacher');
    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³...</option>';
    DB.get('teachers').forEach(t => { select.innerHTML += `<option value="${t.id}">${t.name}</option>`; });
}

function renderGroupsTable() {
    const teachers = DB.get('teachers');
    const tableBody = document.getElementById('groups-table-body');
    tableBody.innerHTML = '';
    DB.get('groups').forEach(g => {
        const teacher = teachers.find(t => t.id === g.teacherId);
        tableBody.innerHTML += `<tr><td>${g.name}</td><td>${teacher ? teacher.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td><td>${g.schedule}</td><td><button class="btn btn-danger btn-sm" onclick="deleteData('groups', '${g.id}')">Ø­Ø°Ù</button></td></tr>`;
    });
}

function populateGroupsDropdown(selectId) {
    const select = document.getElementById(selectId);
    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø©...</option>';
    DB.get('groups').forEach(g => { select.innerHTML += `<option value="${g.id}">${g.name}</option>`; });
}

function renderStudentsTable(filter = '') {
    const groups = DB.get('groups');
    const tableBody = document.getElementById('students-table-body');
    tableBody.innerHTML = '';
    const filteredStudents = DB.get('students').filter(s => s.name.toLowerCase().includes(filter.toLowerCase()) || s.id.toLowerCase().includes(filter.toLowerCase()));
    filteredStudents.forEach(s => {
        const group = groups.find(g => g.id === s.groupId);
        tableBody.innerHTML += `<tr><td>${s.name}</td><td>${s.id}</td><td>${group ? group.name : 'Ø¨Ù„Ø§ Ù…Ø¬Ù…ÙˆØ¹Ø©'}</td><td>${s.stage}</td><td><button class="btn btn-danger btn-sm" onclick="deleteData('students', '${s.id}')">Ø­Ø°Ù</button></td></tr>`;
    });
}

function renderAttendanceLog(dateFilter) {
    const logBody = document.getElementById('attendance-log-body');
    const allLogs = DB.get('attendance');
    const groups = DB.get('groups');
    logBody.innerHTML = '';

    const filteredLogs = allLogs.filter(log => {
        return !dateFilter || log.timestamp.startsWith(dateFilter);
    });

    filteredLogs.reverse().forEach(log => {
        const studentGroup = groups.find(g => g.id === log.groupId) || { name: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' };
        const date = new Date(log.timestamp);
        const formattedDate = date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
        const formattedTime = date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
        
        logBody.innerHTML += `
            <tr>
                <td>${log.studentName}</td>
                <td>${studentGroup.name}</td>
                <td>${formattedDate}</td>
                <td>${formattedTime}</td>
            </tr>
        `;
    });
}

function renderTeacherFinances() {
    const tableBody = document.getElementById('teacher-finances-table-body');
    tableBody.innerHTML = '';
    DB.get('teachers').forEach(teacher => {
        const teacherGroups = DB.get('groups').filter(g => g.teacherId === teacher.id);
        const teacherStudentIds = DB.get('students').filter(s => teacherGroups.some(g => g.id === s.groupId)).map(s => s.id);
        const totalRevenue = DB.get('payments').filter(p => teacherStudentIds.includes(p.studentId)).reduce((sum, p) => sum + p.amount, 0);
        const teacherShare = totalRevenue * (teacher.percentage / 100);
        tableBody.innerHTML += `<tr><td>${teacher.name}</td><td>${totalRevenue.toFixed(2)} Ø¬</td><td>${teacher.percentage}%</td><td>${teacherShare.toFixed(2)} Ø¬</td></tr>`;
    });
}

// ===== DATA HANDLING LOGIC =====
function addData(key, dataObject) {
    const data = DB.get(key);
    data.push(dataObject);
    DB.save(key, data);
    renderDashboard();
}

function addTeacher(e) {
    e.preventDefault();
    addData('teachers', { id: `TCH-${Date.now()}`, name: document.getElementById('teacher-name').value, subject: document.getElementById('teacher-subject').value, percentage: parseInt(document.getElementById('teacher-percentage').value) });
    e.target.reset();
    renderTeachersTable();
}

function addGroup(e) {
    e.preventDefault();
    addData('groups', { id: `GRP-${Date.now()}`, name: document.getElementById('group-name').value, teacherId: document.getElementById('group-teacher').value, schedule: document.getElementById('group-schedule').value });
    e.target.reset();
    renderGroupsTable();
}

function addStudent(e) {
    e.preventDefault();
    const studentId = `STU-${Date.now()}`;
    addData('students', { id: studentId, name: document.getElementById('name').value, stage: document.getElementById('stage').value, parentPhone: document.getElementById('parentPhone').value, groupId: document.getElementById('student-group').value });
    alert(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ (Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯) Ù‡Ùˆ: ${studentId}`);
    e.target.reset();
    renderStudentsTable();
}

function addPayment(e) {
    e.preventDefault();
    const studentId = document.getElementById('payment-student-id').value;
    const student = DB.get('students').find(s => s.id === studentId);
    if (!student) { alert('Ø®Ø·Ø£: ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.'); return; }
    
    const newPayment = { studentId: student.id, amount: parseFloat(document.getElementById('payment-amount').value), date: new Date().toISOString() };
    addData('payments', newPayment);
    
    document.getElementById('receipt-modal-content').innerHTML = `<h5>Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</h5><p>-------------------------</p><p><strong>Ø§Ù„Ø·Ø§Ù„Ø¨:</strong> ${student.name}</p><p><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${newPayment.amount.toFixed(2)} Ø¬</p><p>-------------------------</p><p>Ø´ÙƒØ±Ù‹Ø§ Ù„ÙƒÙ…!</p>`;
    new bootstrap.Modal(document.getElementById('receiptModal')).show();
    
    e.target.reset();
    renderDashboard();
    renderTeacherFinances();
}

function handleAttendance(e) {
    const barcode = e.target.value.trim();
    if (barcode === '') return;
    const student = DB.get('students').find(s => s.id === barcode);
    const feedbackEl = document.getElementById('attendance-feedback');
    if (student) {
        const newLogEntry = { id: `ATT-${Date.now()}`, studentId: student.id, studentName: student.name, groupId: student.groupId, timestamp: new Date().toISOString() };
        const attendanceLog = DB.get('attendance');
        attendanceLog.push(newLogEntry);
        DB.save('attendance', attendanceLog);
        feedbackEl.innerHTML = `<div class="alert alert-success"><strong>Ø­Ø¶ÙˆØ±:</strong> ${student.name}<br><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${new Date(newLogEntry.timestamp).toLocaleTimeString()}</div>`;
        renderAttendanceLog(document.getElementById('attendance-date-filter').value);
    } else {
        feedbackEl.innerHTML = `<div class="alert alert-danger"><strong>Ø®Ø·Ø£:</strong> Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…Ø³Ø¬Ù„.</div>`;
    }
    setTimeout(() => { e.target.value = ''; feedbackEl.innerHTML = ''; }, 3000);
}

function startGradesEntry(e) {
    e.preventDefault();
    const groupId = document.getElementById('exam-group').value;
    const examName = document.getElementById('exam-name').value;
    if (!groupId) { alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£ÙˆÙ„Ø§Ù‹.'); return; }
    const studentsInGroup = DB.get('students').filter(s => s.groupId === groupId);
    const tableBody = document.getElementById('grades-entry-body');
    tableBody.innerHTML = '';
    studentsInGroup.forEach(student => {
        tableBody.innerHTML += `<tr><td>${student.name}</td><td><input type="number" class="form-control grade-input" data-student-id="${student.id}" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø©"></td></tr>`;
    });
    document.getElementById('grades-entry-title').innerText = `Ø±ØµØ¯ Ø¯Ø±Ø¬Ø§Øª Ø§Ù…ØªØ­Ø§Ù† "${examName}"`;
    document.getElementById('grades-entry-card').style.display = 'block';
}

function saveGrades() {
    const examName = document.getElementById('exam-name').value;
    const groupId = document.getElementById('exam-group').value;
    const gradeInputs = document.querySelectorAll('.grade-input');
    const newExam = { id: `EXM-${Date.now()}`, name: examName, groupId: groupId, grades: [] };
    gradeInputs.forEach(input => {
        if (input.value) {
            newExam.grades.push({ studentId: input.dataset.studentId, grade: parseFloat(input.value) });
        }
    });
    addData('exams', newExam);
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
    document.getElementById('grades-entry-card').style.display = 'none';
    document.getElementById('add-exam-form').reset();
}

function deleteData(key, id) {
    if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©.`)) {
        let data = DB.get(key);
        data = data.filter(item => item.id !== id);
        DB.save(key, data);
        showPage(document.querySelector('.main-content .page.active').id);
    }
}

function clearData() {
    if (confirm('ØªØ­Ø°ÙŠØ±! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ²ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
        localStorage.clear();
        sessionStorage.clear();
        location.reload();
    }
}

function printReceipt() {
    const receiptContent = document.getElementById('receipt-modal-content').innerHTML;
    const originalContent = document.body.innerHTML;
    document.body.innerHTML = receiptContent;
    window.print();
    document.body.innerHTML = originalContent;
    location.reload();
}

// ===== APP INITIALIZATION =====
function initialize_app() {
    showPage('dashboard');
    document.getElementById('add-teacher-form').addEventListener('submit', addTeacher);
    document.getElementById('add-group-form').addEventListener('submit', addGroup);
    document.getElementById('add-student-form').addEventListener('submit', addStudent);
    document.getElementById('search-student').addEventListener('keyup', (e) => renderStudentsTable(e.target.value));
    document.getElementById('barcode-input').addEventListener('change', handleAttendance);
    document.getElementById('attendance-date-filter').addEventListener('change', (e) => renderAttendanceLog(e.target.value));
    document.getElementById('add-payment-form').addEventListener('submit', addPayment);
    document.getElementById('add-exam-form').addEventListener('submit', startGradesEntry);
    document.getElementById('save-grades-btn').addEventListener('click', saveGrades);
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('login-form').addEventListener('submit', handleLogin);
    checkLogin();
});
</script>

</body>
</html>
