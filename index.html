<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المركز التعليمي (Google Apps Script)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        body { 
            background-color: #f8f9fa; 
            font-family: 'Tajawal', sans-serif; 
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
        
        #login-screen, #loader-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: #343a40; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; 
        }
        #login-box { 
            background: white; padding: 2rem; border-radius: 0.5rem; width: 100%; max-width: 400px; box-shadow: 0 0 15px rgba(0,0,0,0.2); 
        }
        #app-wrapper { 
            display: none; 
            flex: 1; /* This makes the wrapper grow to fill available space */
            flex-direction: column;
        }
        .main-content .page { display: none; }
        .main-content .page.active { display: block; }
        
        .sidebar { 
            height: calc(100vh - 56px); position: sticky; top: 56px;
            background-color: #343a40; color: white; overflow-y: auto; 
        }
        .sidebar .nav-link { 
            color: #adb5bd; cursor: pointer; border-radius: 0.25rem; margin-bottom: 0.25rem; display: flex; align-items: center;
        }
        .sidebar .nav-link i { margin-left: 10px; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: white; background-color: #495057; }

        .offcanvas-body .nav-link { color: #adb5bd; font-size: 1.1rem; padding: 0.75rem 1rem; }
        .offcanvas-body .nav-link:hover, .offcanvas-body .nav-link.active { color: white; background-color: #495057; }

        .stat-card { border: none; border-radius: 0.5rem; color: white; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        .card-icon { font-size: 3rem; opacity: 0.7; }
        #receipt-modal-content { font-family: 'Courier New', Courier, monospace; text-align: center; }
        .table-responsive { max-height: 450px; overflow-y: auto; }
        .card { border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .navbar-brand { font-weight: bold; }

        .footer {
            padding: 1rem 0;
            background-color: #343a40;
            color: #f8f9fa;
            flex-shrink: 0; /* Prevents footer from shrinking */
        }
        .footer a {
            color: #ffffff;
            text-decoration: none;
            font-weight: bold;
        }
        .footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

<!-- Loader Screen -->
<div id="loader-screen" style="display: none;">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">جار التحميل...</span>
    </div>
</div>

<!-- Login Screen -->
<div id="login-screen">
    <div id="login-box" class="text-center">
        <h3 class="mb-4">تسجيل الدخول</h3>
        <form id="login-form">
            <div class="form-floating mb-3">
                <input type="password" class="form-control" id="password" placeholder="Password" required>
                <label for="password">كلمة المرور</label>
            </div>
            <button type="submit" class="btn btn-primary w-100">دخول</button>
            <div id="login-error" class="text-danger mt-2" style="display: none;">كلمة المرور غير صحيحة.</div>
        </form>
        <hr>
        <button id="test-connection-btn" class="btn btn-outline-secondary w-100">اختبار الاتصال بقاعدة البيانات</button>
        <div id="test-connection-result" class="mt-2"></div>
    </div>
</div>

<div id="app-wrapper" class="d-flex flex-column">
    <!-- Top Navbar -->
    <nav class="navbar navbar-dark bg-dark sticky-top flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">إدارة المركز</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobile-sidebar" aria-controls="mobile-sidebar">
            <span class="navbar-toggler-icon"></span>
        </button>
    </nav>

    <!-- Mobile Sidebar (Offcanvas) -->
    <div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="mobile-sidebar" aria-labelledby="mobile-sidebar-label">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="mobile-sidebar-label">القائمة</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="nav flex-column" id="mobile-nav-links"></ul>
        </div>
    </div>

    <div class="container-fluid flex-grow-1">
        <div class="row h-100">
            <!-- Desktop Sidebar -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-none d-md-block sidebar p-3">
                <ul class="nav flex-column" id="desktop-nav-links"></ul>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 pt-4 main-content">
                <!-- Dashboard Page -->
                <div id="dashboard" class="page active">
                    <h3>لوحة التحكم</h3>
                    <!-- Main Stats -->
                    <div class="row mt-4">
                        <div class="col-lg-4 col-md-6 mb-4"><div class="card stat-card bg-primary p-3"><div class="d-flex justify-content-between align-items-center"><div><h5>الطلاب</h5><h2 id="total-students-stat">0</h2></div><div class="card-icon">🧑‍🎓</div></div></div></div>
                        <div class="col-lg-4 col-md-6 mb-4"><div class="card stat-card bg-info p-3"><div class="d-flex justify-content-between align-items-center"><div><h5>المدرسون</h5><h2 id="total-teachers-stat">0</h2></div><div class="card-icon">👨‍🏫</div></div></div></div>
                        <div class="col-lg-4 col-md-6 mb-4"><div class="card stat-card bg-secondary p-3"><div class="d-flex justify-content-between align-items-center"><div><h5>المجموعات</h5><h2 id="total-groups-stat">0</h2></div><div class="card-icon">📚</div></div></div></div>
                    </div>

                    <!-- Daily Stats -->
                    <h4 class="mt-4 border-bottom pb-2">إحصائيات اليوم</h4>
                    <div class="row mt-3">
                        <!-- Daily Revenue Card (Password Protected) -->
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div id="show-daily-revenue-prompt">
                                <div class="card p-3 h-100 d-flex flex-column justify-content-center align-items-center bg-light">
                                    <h5 class="card-title text-muted">إيرادات اليوم</h5>
                                    <i class="bi bi-lock-fill fs-2 text-muted my-2"></i>
                                    <button id="show-daily-revenue-btn" class="btn btn-primary btn-sm mt-2">عرض البيانات</button>
                                </div>
                            </div>
                            <div id="daily-revenue-view" style="display: none;">
                                <div class="card stat-card bg-warning p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div><h5>إيرادات اليوم</h5><h2 id="daily-revenue-stat">0</h2></div>
                                        <div class="card-icon">💰</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <!-- Daily Attendance Card -->
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card stat-card p-3" style="background-color: #17a2b8;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div><h5>حضور اليوم</h5><h2 id="daily-attendance-stat">0</h2></div>
                                    <div class="card-icon">✅</div>
                                </div>
                            </div>
                        </div>
                        <!-- New Students Card -->
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card stat-card p-3" style="background-color: #28a745;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div><h5>طلاب جدد اليوم</h5><h2 id="daily-new-students-stat">0</h2></div>
                                    <div class="card-icon">✨</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Other Pages (Teachers, Groups, etc.) -->
                <div id="teachers" class="page">
                    <h3>إدارة المدرسين</h3>
                    <div class="card p-3 mb-4"><form id="add-teacher-form" class="row g-3 align-items-end"><div class="col-md-5"><label class="form-label">اسم المدرس</label><input type="text" id="teacher-name" class="form-control" required></div><div class="col-md-4"><label class="form-label">المادة</label><input type="text" id="teacher-subject" class="form-control" required></div><div class="col-md-2"><label class="form-label">النسبة (%)</label><input type="number" id="teacher-percentage" class="form-control" required min="0" max="100"></div><div class="col-md-1"><button type="submit" class="btn btn-primary w-100">إضافة</button></div></form></div>
                    <div class="card p-3"><h5 class="card-title">قائمة المدرسين</h5><div class="table-responsive"><table class="table table-striped"><thead><tr><th>الاسم</th><th>المادة</th><th>النسبة</th><th>إجراءات</th></tr></thead><tbody id="teachers-table-body"></tbody></table></div></div>
                </div>

                <div id="groups" class="page">
                    <h3>إدارة المجموعات</h3>
                    <div class="card p-3 mb-4"><form id="add-group-form" class="row g-3 align-items-end"><div class="col-md-4"><label class="form-label">اسم المجموعة</label><input type="text" id="group-name" class="form-control" required></div><div class="col-md-3"><label class="form-label">المدرس</label><select id="group-teacher" class="form-select" required></select></div><div class="col-md-4"><label class="form-label">المواعيد</label><input type="text" id="group-schedule" class="form-control" placeholder="مثال: سبت - اثنين (5م)" required></div><div class="col-md-1"><button type="submit" class="btn btn-primary w-100">إنشاء</button></div></form></div>
                    <div class="card p-3"><h5 class="card-title">قائمة المجموعات</h5><div class="table-responsive"><table class="table table-striped"><thead><tr><th>اسم المجموعة</th><th>المدرس</th><th>المواعيد</th><th>إجراءات</th></tr></thead><tbody id="groups-table-body"></tbody></table></div></div>
                </div>

                <div id="students" class="page">
                    <h3>إدارة الطلاب</h3>
                    <div class="card p-3 mb-4">
                        <form id="add-student-form" class="row g-3 align-items-end">
                            <div class="col-md-3"><label class="form-label">اسم الطالب</label><input type="text" id="name" class="form-control" required></div>
                            <div class="col-md-2"><label class="form-label">كود الطالب (5 أرقام)</label><input type="text" id="student-code" class="form-control" placeholder="اتركه فارغاً للتلقائي"></div>
                            <div class="col-md-2"><label class="form-label">المرحلة</label><input type="text" id="stage" class="form-control" required></div>
                            <div class="col-md-2"><label class="form-label">هاتف ولي الأمر</label><input type="tel" id="parentPhone" class="form-control" required></div>
                            <div class="col-md-2"><label class="form-label">المجموعة</label><select id="student-group" class="form-select" required></select></div>
                            <div class="col-md-1"><button type="submit" class="btn btn-primary w-100">إضافة</button></div>
                        </form>
                    </div>
                    <div class="card p-3"><h5 class="card-title">قائمة الطلاب</h5><input type="text" id="search-student" class="form-control mb-3" placeholder="ابحث بالاسم أو الكود..."><div class="table-responsive"><table class="table table-striped"><thead><tr><th>الاسم</th><th>الكود</th><th>المجموعة</th><th>المرحلة</th><th>إجراءات</th></tr></thead><tbody id="students-table-body"></tbody></table></div></div>
                </div>

                <div id="attendance" class="page">
                    <h3>الحضور والغياب</h3>
                    <div class="card p-3 mb-4">
                        <h5>تسجيل الحضور بالباركود</h5>
                        <p>قم بتوجيه قارئ الباركود نحو حقل الإدخال أدناه.</p>
                        <input type="text" id="barcode-input" class="form-control form-control-lg" placeholder="في انتظار قراءة الباركود...">
                        <div id="attendance-feedback" class="mt-3"></div>
                    </div>
                    <div class="card p-3">
                        <h5 class="card-title">سجل الحضور</h5>
                        <div class="row mb-3 g-3">
                            <div class="col-md-4"><label class="form-label">فلترة بالتاريخ</label><input type="date" id="attendance-date-filter" class="form-control"></div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead><tr><th>اسم الطالب</th><th>المجموعة</th><th>التاريخ</th><th>الوقت</th></tr></thead>
                                <tbody id="attendance-log-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="grades" class="page">
                    <h3>الامتحانات والدرجات</h3>
                    <div class="card p-3 mb-4">
                        <h5>إضافة امتحان جديد</h5>
                        <form id="add-exam-form" class="row g-3 align-items-end">
                            <div class="col-md-5"><label class="form-label">اختر المجموعة</label><select id="exam-group" class="form-select" required></select></div>
                            <div class="col-md-5"><label class="form-label">اسم الامتحان</label><input type="text" id="exam-name" class="form-control" placeholder="مثال: امتحان شهر أكتوبر" required></div>
                            <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">بدء الرصد</button></div>
                        </form>
                    </div>
                    <div class="card p-3 mb-4" id="grades-entry-card" style="display:none;">
                        <h5 id="grades-entry-title"></h5>
                        <div class="table-responsive"><table class="table"><thead><tr><th>اسم الطالب</th><th>الدرجة</th></tr></thead><tbody id="grades-entry-body"></tbody></table></div>
                        <button class="btn btn-success mt-3" id="save-grades-btn">حفظ جميع الدرجات</button>
                    </div>
                    <div class="card p-3">
                        <h5 class="card-title">عرض نتائج الامتحانات</h5>
                        <div class="row g-3 mb-3 align-items-end">
                            <div class="col-md-5"><label class="form-label">اختر المجموعة</label><select id="view-exam-group-filter" class="form-select"></select></div>
                            <div class="col-md-5"><label class="form-label">اختر الامتحان</label><select id="view-exam-filter" class="form-select"></select></div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead><tr><th>اسم الطالب</th><th>الدرجة</th></tr></thead>
                                <tbody id="exam-results-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="finance" class="page">
                    <h3>الإدارة المالية</h3>
                    <div class="card p-3 mb-4">
                        <h5 class="card-title">تسجيل دفعة جديدة</h5>
                        <form id="add-payment-form" class="row g-3 align-items-end">
                            <div class="col-md-5"><label class="form-label">كود الطالب</label><input type="text" class="form-control" id="payment-student-id" required></div>
                            <div class="col-md-5"><label class="form-label">المبلغ المدفوع</label><input type="number" class="form-control" id="payment-amount" required></div>
                            <div class="col-md-2"><button type="submit" class="btn btn-success w-100">تسجيل</button></div>
                        </form>
                    </div>
                    <div class="card p-3">
                        <div id="teacher-finances-view" style="display: none;">
                            <h5 class="card-title">حسابات المدرسين</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead><tr><th>المدرس</th><th>إجمالي الإيرادات</th><th>نسبة المدرس</th><th>مستحقات المدرس</th></tr></thead>
                                    <tbody id="teacher-finances-table-body"></tbody>
                                </table>
                            </div>
                            <hr>
                            <h5 class="card-title mt-3">طباعة التقارير</h5>
                            <div class="row g-3 align-items-end">
                                <div class="col-md-5">
                                    <label for="report-teacher-select" class="form-label">اختر المدرس</label>
                                    <select id="report-teacher-select" class="form-select"></select>
                                </div>
                                <div class="col-md-3">
                                    <button id="print-report-btn" class="btn btn-secondary w-100">طباعة التقرير</button>
                                </div>
                            </div>
                        </div>
                        <div id="show-finances-prompt">
                            <button id="show-finances-btn" class="btn btn-primary">عرض حسابات المدرسين والأرباح</button>
                        </div>
                    </div>
                </div>
                
                <div id="student-details" class="page">
                    <button class="btn btn-secondary mb-3" onclick="showPage('students')"><i class="bi bi-arrow-right"></i> العودة إلى قائمة الطلاب</button>
                    <h3 id="student-details-name"></h3>
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card p-3">
                                <h5 class="card-title">سجل الحضور</h5>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead><tr><th>التاريخ</th><th>الوقت</th></tr></thead>
                                        <tbody id="student-attendance-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card p-3">
                                <h5 class="card-title">سجل الدرجات</h5>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead><tr><th>الامتحان</th><th>الدرجة</th></tr></thead>
                                        <tbody id="student-grades-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <footer class="footer">
        <div class="container text-center">
            <span>Made with ❤ by <a href="https://wa.me/message/ZOYOVTK4TGTGO1" target="_blank">Ahmed Salem</a>, CEO of <a href="https://algohive.net" target="_blank">AlgoHive Solution</a></span>
        </div>
    </footer>
</div>


<!-- Receipt Modal -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receiptModalLabel">إيصال استلام</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="receipt-modal-content"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                <button type="button" class="btn btn-primary" onclick="printReceipt()">طباعة</button>
            </div>
        </div>
    </div>
</div>

<!-- Finance Password Modal -->
<div class="modal fade" id="financePasswordModal" tabindex="-1" aria-labelledby="financePasswordModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="financePasswordModalLabel">مطلوب كلمة مرور</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="showPage('dashboard')"></button>
            </div>
            <div class="modal-body">
                <p>لعرض البيانات المالية، يرجى إدخال كلمة المرور.</p>
                <form id="finance-password-form">
                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="finance-password-input" placeholder="Password" required>
                        <label for="finance-password-input">كلمة المرور</label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">دخول</button>
                    <div id="finance-password-error" class="text-danger mt-2" style="display: none;">كلمة المرور غير صحيحة.</div>
                </form>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ===================================================================================
// ===== إعدادات Google Apps Script - هام جداً =====
// ===================================================================================
// 1. اتبع دليل الإعداد الذي تم تزويدك به لنشر الكود كـ "Web App".
// 2. الصق رابط تطبيق الويب (Web app URL) الذي حصلت عليه هنا.
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw2fTn4Gz6eaiyb5tBA9m9yf7L2hiuvL6_1vvp5R6DoiKIvrJxezH3ByZfpG6DLvhGZyA/exec";

// كلمات المرور
const APP_PASSWORD = '123'; // كلمة المرور الرئيسية
const FINANCE_PASSWORD = '12345'; // كلمة مرور قسم المالية
// ===================================================================================

// Global state
let currentStudentDetailsId = null;
let allStudents = [];
let allGroups = [];
let allTeachers = [];
let allExams = [];
let allAttendance = [];
let allPayments = [];
let financePasswordModal;
let financeAuthInterval;

// ===== API HELPER =====
async function getData(sheetName) {
    const url = `${GOOGLE_SCRIPT_URL}?sheet=${sheetName}&${new Date().getTime()}`; // Prevent caching
    try {
        const response = await fetch(url, { redirect: 'follow' });
        if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
        const result = await response.json();
        if (result.error) throw new Error(result.error);
        return result;
    } catch (error) {
        console.error('Fetch Error (GET):', error);
        throw error; // Re-throw to be caught by the caller
    }
}

async function postData(payload) {
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors', 
            body: JSON.stringify(payload),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
        });
        if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
        const result = await response.json();
        if (result.error) throw new Error(result.error);
        return result;
    } catch (error) {
        console.error('Fetch Error (POST):', error);
        throw error; // Re-throw to be caught by the caller
    }
}

// ===== AUTH LOGIC & CONNECTION TEST =====
function handleLogin(e) {
    e.preventDefault();
    const password = document.getElementById('password').value;
    if (password === APP_PASSWORD) {
        sessionStorage.setItem('isLoggedIn', 'true');
        checkLogin();
    } else {
        document.getElementById('login-error').style.display = 'block';
    }
}

async function testConnection() {
    const resultDiv = document.getElementById('test-connection-result');
    resultDiv.className = 'mt-2';
    resultDiv.innerHTML = `<div class="spinner-border spinner-border-sm" role="status"></div> جاري الاختبار...`;

    if (GOOGLE_SCRIPT_URL.includes("الصق هنا")) {
        resultDiv.className = 'mt-2 alert alert-danger';
        resultDiv.innerHTML = '<strong>خطأ:</strong> لم تقم بلصق رابط تطبيق الويب في الكود.';
        return;
    }
    
    try {
        await getData('Teachers'); // Test by fetching a known sheet
        resultDiv.className = 'mt-2 alert alert-success';
        resultDiv.innerHTML = '<strong>نجاح!</strong> الاتصال بقاعدة البيانات يعمل بشكل صحيح.';
    } catch (error) {
        resultDiv.className = 'mt-2 alert alert-danger';
        resultDiv.innerHTML = `<strong>فشل الاتصال.</strong> تأكد من أنك قمت بنشر الكود في Apps Script بشكل صحيح وأن صلاحية الوصول مضبوطة على "Anyone".`;
        console.error("Test Connection failed:", error);
    }
}

function handleFinanceLogin(e) {
    e.preventDefault();
    const password = document.getElementById('finance-password-input').value;
    const errorDiv = document.getElementById('finance-password-error');
    if (password === FINANCE_PASSWORD) {
        sessionStorage.setItem('financeUnlocked', 'true');
        sessionStorage.setItem('financeUnlockTimestamp', Date.now()); // Set timestamp
        errorDiv.style.display = 'none';
        financePasswordModal.hide();
        updateFinanceView();
    } else {
        errorDiv.style.display = 'block';
    }
}

function checkFinanceAuthTimeout() {
    const unlockTimestamp = sessionStorage.getItem('financeUnlockTimestamp');
    if (unlockTimestamp) {
        const tenMinutes = 10 * 60 * 1000;
        if (Date.now() - parseInt(unlockTimestamp) > tenMinutes) {
            sessionStorage.removeItem('financeUnlocked');
            sessionStorage.removeItem('financeUnlockTimestamp');
            updateFinanceView();
        }
    }
}

function logout() {
    sessionStorage.removeItem('isLoggedIn');
    sessionStorage.removeItem('financeUnlocked');
    sessionStorage.removeItem('financeUnlockTimestamp');
    if(financeAuthInterval) clearInterval(financeAuthInterval);
    location.reload();
}

function checkLogin() {
    if (sessionStorage.getItem('isLoggedIn') === 'true') {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-wrapper').style.display = 'flex'; // Use flex for sticky footer
        initializeApp();
    } else {
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('app-wrapper').style.display = 'none';
    }
}

// ===== UI LOGIC =====
function showPage(pageId, studentId = null) {
    currentStudentDetailsId = studentId; 
    document.querySelectorAll('.main-content .page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    
    const navLinks = document.querySelectorAll('.sidebar .nav-link, .offcanvas-body .nav-link');
    navLinks.forEach(l => l.classList.remove('active'));
    
    const activeLinks = document.querySelectorAll(`.nav-link[onclick*="showPage('${pageId}')"]`);
    activeLinks.forEach(link => {
        if (!link.closest('#student-details')) {
             link.classList.add('active');
        }
    });

    const offcanvasElement = document.getElementById('mobile-sidebar');
    if (offcanvasElement && offcanvasElement.classList.contains('show')) {
        const offcanvasInstance = bootstrap.Offcanvas.getInstance(offcanvasElement);
        if (offcanvasInstance) {
            offcanvasInstance.hide();
        }
    }

    if (pageId === 'student-details') renderStudentDetails();
}

function showFinanceDetails() {
    if (sessionStorage.getItem('financeUnlocked') === 'true') {
        updateFinanceView();
    } else {
        financePasswordModal.show();
    }
}

function updateFinanceView() {
    const isUnlocked = sessionStorage.getItem('financeUnlocked') === 'true';

    // Toggle Finance Page elements
    document.getElementById('teacher-finances-view').style.display = isUnlocked ? 'block' : 'none';
    document.getElementById('show-finances-prompt').style.display = isUnlocked ? 'none' : 'block';

    // Toggle Dashboard Page elements (Daily Revenue)
    document.getElementById('daily-revenue-view').style.display = isUnlocked ? 'block' : 'none';
    document.getElementById('show-daily-revenue-prompt').style.display = isUnlocked ? 'none' : 'block';
}


// ===== DATA LOADING =====
async function loadAllData() {
    document.getElementById('loader-screen').style.display = 'flex';
    
    try {
        const [teachersRes, groupsRes, studentsRes, attendanceRes, paymentsRes, examsRes] = await Promise.all([
            getData('Teachers'),
            getData('Groups'),
            getData('Students'),
            getData('Attendance'),
            getData('Payments'),
            getData('Exams')
        ]);

        allTeachers = teachersRes;
        allGroups = groupsRes;
        allStudents = studentsRes;
        allAttendance = (attendanceRes || []).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        allPayments = paymentsRes;
        allExams = (examsRes || []).map(exam => ({ ...exam, grades: JSON.parse(exam.grades || '[]') }));

        renderAll();
    } catch (error) {
        console.error("Failed to load data from Google Script:", error);
        alert("فشل تحميل البيانات. يرجى التأكد من صحة رابط Google Script وأنك قمت بنشره بشكل صحيح مع إعطاء صلاحية الوصول للجميع (Anyone).");
    } finally {
        document.getElementById('loader-screen').style.display = 'none';
    }
}

function renderAll() {
    renderDashboard();
    renderTeachersTable();
    renderGroupsTable();
    renderStudentsTable();
    renderAttendanceLog();
    renderTeacherFinances();
    populateTeachersDropdown();
    populateGroupsDropdown('student-group');
    populateGroupsDropdown('exam-group');
    populateGroupsDropdown('view-exam-group-filter');
    populateExamFilter();
    updateFinanceView(); // This function now updates both dashboard and finance views
    populateTeacherReportDropdown();
}


// ===== RENDER FUNCTIONS =====
function renderDashboard() {
    // General Stats
    document.getElementById('total-students-stat').innerText = allStudents.length;
    document.getElementById('total-teachers-stat').innerText = allTeachers.length;
    document.getElementById('total-groups-stat').innerText = allGroups.length;

    // Daily Stats
    const today = new Date().toISOString().slice(0, 10);

    // Daily Revenue
    const dailyRevenue = allPayments
        .filter(p => p.date && p.date.slice(0, 10) === today)
        .reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
    document.getElementById('daily-revenue-stat').innerText = `${dailyRevenue.toFixed(2)} ج`;
    
    // Daily Attendance
    const dailyAttendance = allAttendance.filter(att => att.timestamp && att.timestamp.slice(0, 10) === today).length;
    document.getElementById('daily-attendance-stat').innerText = dailyAttendance;

    // New Students Today
    const dailyNewStudents = allStudents.filter(s => {
        const timestamp = parseInt(s.id.split('-')[2]);
        if (isNaN(timestamp)) return false;
        const registrationDate = new Date(timestamp).toISOString().slice(0, 10);
        return registrationDate === today;
    }).length;
    document.getElementById('daily-new-students-stat').innerText = dailyNewStudents;
}

function renderTeachersTable() {
    const tableBody = document.getElementById('teachers-table-body');
    tableBody.innerHTML = '';
    allTeachers.forEach(t => { tableBody.innerHTML += `<tr><td>${t.name}</td><td>${t.subject}</td><td>${t.percentage}%</td><td><button class="btn btn-danger btn-sm" onclick="deleteData('Teachers', 'id', '${t.id}')">حذف</button></td></tr>`; });
}

function populateTeachersDropdown() {
    const select = document.getElementById('group-teacher');
    select.innerHTML = '<option value="">اختر مدرس...</option>';
    allTeachers.forEach(t => { select.innerHTML += `<option value="${t.name}">${t.name}</option>`; });
}

function renderGroupsTable() {
    const tableBody = document.getElementById('groups-table-body');
    tableBody.innerHTML = '';
    allGroups.forEach(g => {
        tableBody.innerHTML += `<tr><td>${g.name}</td><td>${g.teacherName || 'غير محدد'}</td><td>${g.schedule}</td><td><button class="btn btn-danger btn-sm" onclick="deleteData('Groups', 'id', '${g.id}')">حذف</button></td></tr>`;
    });
}

function populateGroupsDropdown(selectId) {
    const select = document.getElementById(selectId);
    const currentValue = select.value;
    select.innerHTML = '<option value="">اختر مجموعة...</option>';
    allGroups.forEach(g => { select.innerHTML += `<option value="${g.id}">${g.name}</option>`; });
    select.value = currentValue;
}

function renderStudentsTable(filter = '') {
    const tableBody = document.getElementById('students-table-body');
    tableBody.innerHTML = '';
    const filteredStudents = allStudents.filter(s => s.name.toLowerCase().includes(filter.toLowerCase()) || (s.barcode && s.barcode.toLowerCase().includes(filter.toLowerCase())));
    filteredStudents.forEach(s => {
        const group = allGroups.find(g => g.id === s.groupId);
        tableBody.innerHTML += `<tr>
            <td>${s.name}</td>
            <td>${s.barcode}</td>
            <td>${group ? group.name : 'بلا مجموعة'}</td>
            <td>${s.stage}</td>
            <td>
                <button class="btn btn-info btn-sm" onclick="showPage('student-details', '${s.id}')">التفاصيل</button>
                <button class="btn btn-danger btn-sm" onclick="deleteData('Students', 'id', '${s.id}')">حذف</button>
            </td>
        </tr>`;
    });
}

function renderTeacherFinances() {
    const tableBody = document.getElementById('teacher-finances-table-body');
    tableBody.innerHTML = '';
    allTeachers.forEach(teacher => {
        const teacherGroups = allGroups.filter(g => g.teacherName === teacher.name);
        const teacherGroupIds = teacherGroups.map(g => g.id);
        const teacherStudentIds = allStudents.filter(s => teacherGroupIds.includes(s.groupId)).map(s => s.id);
        const totalRevenue = allPayments.filter(p => teacherStudentIds.includes(p.studentId)).reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
        const teacherShare = totalRevenue * (parseFloat(teacher.percentage || 0) / 100);
        tableBody.innerHTML += `<tr><td>${teacher.name}</td><td>${totalRevenue.toFixed(2)} ج</td><td>${teacher.percentage || 0}%</td><td>${teacherShare.toFixed(2)} ج</td></tr>`;
    });
}

function populateTeacherReportDropdown() {
    const select = document.getElementById('report-teacher-select');
    select.innerHTML = '<option value="all">كل المدرسين</option>';
    allTeachers.forEach(t => { select.innerHTML += `<option value="${t.name}">${t.name}</option>`; });
}


function renderAttendanceLog() {
    const dateFilter = document.getElementById('attendance-date-filter').value;
    const tableBody = document.getElementById('attendance-log-body');
    tableBody.innerHTML = '';

    let filteredData = allAttendance;
    if (dateFilter) {
        filteredData = allAttendance.filter(att => att.timestamp && att.timestamp.startsWith(dateFilter));
    }

    filteredData.forEach(att => {
        const student = allStudents.find(s => s.id === att.studentId);
        if (student) {
            const group = allGroups.find(g => g.id === student.groupId);
            const aDate = new Date(att.timestamp);
            tableBody.innerHTML += `<tr>
                <td>${student.name}</td>
                <td>${group ? group.name : 'غير محدد'}</td>
                <td>${aDate.toLocaleDateString('ar-EG')}</td>
                <td>${aDate.toLocaleTimeString('ar-EG')}</td>
            </tr>`;
        }
    });
}

function populateExamFilter() {
    const groupId = document.getElementById('view-exam-group-filter').value;
    const examSelect = document.getElementById('view-exam-filter');
    examSelect.innerHTML = '<option value="">اختر امتحان...</option>';
    if (groupId) {
        const groupExams = allExams.filter(ex => ex.groupId === groupId);
        groupExams.forEach(ex => {
            examSelect.innerHTML += `<option value="${ex.id}">${ex.name}</option>`;
        });
    }
    renderExamResults();
}

function renderExamResults() {
    const examId = document.getElementById('view-exam-filter').value;
    const tableBody = document.getElementById('exam-results-body');
    tableBody.innerHTML = '';
    if (examId) {
        const exam = allExams.find(ex => ex.id === examId);
        if (exam) {
            exam.grades.forEach(grade => {
                const student = allStudents.find(s => s.id === grade.studentId);
                tableBody.innerHTML += `<tr>
                    <td>${student ? student.name : 'طالب محذوف'}</td>
                    <td>${grade.grade}</td>
                </tr>`;
            });
        }
    }
}

function renderStudentDetails() {
    if (!currentStudentDetailsId) return;
    const student = allStudents.find(s => s.id === currentStudentDetailsId);
    if (!student) {
        showPage('students');
        return;
    }

    document.getElementById('student-details-name').innerText = `تفاصيل الطالب: ${student.name}`;
    
    const attendanceBody = document.getElementById('student-attendance-body');
    attendanceBody.innerHTML = '';
    allAttendance.filter(att => att.studentId === student.id).forEach(att => {
        const aDate = new Date(att.timestamp);
        attendanceBody.innerHTML += `<tr><td>${aDate.toLocaleDateString('ar-EG')}</td><td>${aDate.toLocaleTimeString('ar-EG')}</td></tr>`;
    });

    const gradesBody = document.getElementById('student-grades-body');
    gradesBody.innerHTML = '';
    allExams.forEach(exam => {
        const gradeInfo = exam.grades.find(g => g.studentId === student.id);
        if (gradeInfo) {
            gradesBody.innerHTML += `<tr><td>${exam.name}</td><td>${gradeInfo.grade}</td></tr>`;
        }
    });
}

// ===== DATA HANDLING LOGIC =====
async function addData(tabName, data) {
    const payload = {
        action: 'add',
        sheetName: tabName,
        data: data
    };
    await postData(payload);
    loadAllData();
}

async function deleteData(tabName, key, value) {
    if (confirm(`هل أنت متأكد من الحذف؟`)) {
        const payload = {
            action: 'delete',
            sheetName: tabName,
            key: key,
            value: value
        };
        await postData(payload);
        loadAllData();
    }
}

function addTeacher(e) {
    e.preventDefault();
    const data = {
        id: `TCH-${Date.now()}`,
        name: document.getElementById('teacher-name').value,
        subject: document.getElementById('teacher-subject').value,
        percentage: document.getElementById('teacher-percentage').value
    };
    addData('Teachers', data).then(() => e.target.reset());
}

function addGroup(e) {
    e.preventDefault();
    const data = {
        id: `GRP-${Date.now()}`,
        name: document.getElementById('group-name').value,
        teacherName: document.getElementById('group-teacher').value,
        schedule: document.getElementById('group-schedule').value
    };
    addData('Groups', data).then(() => e.target.reset());
}

function generateUniqueStudentCode() {
    let newCode;
    let isUnique = false;
    do {
        newCode = Math.floor(10000 + Math.random() * 90000).toString();
        if (!allStudents.some(student => student.barcode === newCode)) {
            isUnique = true;
        }
    } while (!isUnique);
    return newCode;
}

function addStudent(e) {
    e.preventDefault();
    const customCode = document.getElementById('student-code').value.trim();
    let studentBarcode;

    if (customCode) {
        if (!/^\d{5}$/.test(customCode)) {
            alert("خطأ: كود الطالب يجب أن يتكون من 5 أرقام فقط.");
            return;
        }
        if (allStudents.some(student => student.barcode === customCode)) {
            alert("خطأ: هذا الكود مستخدم بالفعل. يرجى إدخال كود آخر أو تركه فارغاً.");
            return;
        }
        studentBarcode = customCode;
    } else {
        studentBarcode = generateUniqueStudentCode();
    }

    const data = {
        id: `STU-ID-${Date.now()}`,
        name: document.getElementById('name').value,
        stage: document.getElementById('stage').value,
        parentPhone: document.getElementById('parentPhone').value,
        groupId: document.getElementById('student-group').value,
        barcode: studentBarcode
    };
    addData('Students', data).then(() => {
        alert(`تمت إضافة الطالب بنجاح! كود الطالب هو: ${studentBarcode}`);
        e.target.reset();
    });
}

function addPayment(e) {
    e.preventDefault();
    const studentBarcode = document.getElementById('payment-student-id').value;
    const student = allStudents.find(s => s.barcode === studentBarcode);
    if (!student) { alert('خطأ: كود الطالب غير موجود.'); return; }
    
    const data = { 
        id: `PAY-${Date.now()}`,
        studentId: student.id, 
        amount: document.getElementById('payment-amount').value, 
        date: new Date().toISOString()
    };
    
    addData('Payments', data).then(() => {
        document.getElementById('receipt-modal-content').innerHTML = `<h5>المركز التعليمي</h5><p>-------------------------</p><p><strong>الطالب:</strong> ${student.name}</p><p><strong>المبلغ:</strong> ${parseFloat(data.amount).toFixed(2)} ج</p><p>-------------------------</p><p>شكرًا لكم!</p>`;
        new bootstrap.Modal(document.getElementById('receiptModal')).show();
        e.target.reset();
    });
}

function handleAttendance(e) {
    const barcode = e.target.value.trim();
    if (barcode === '') return;
    const student = allStudents.find(s => s.barcode === barcode);
    const feedbackEl = document.getElementById('attendance-feedback');
    if (student) {
        const data = {
            id: `ATT-${Date.now()}`,
            studentId: student.id,
            timestamp: new Date().toISOString()
        };
        addData('Attendance', data);
        feedbackEl.innerHTML = `<div class="alert alert-success"><strong>حضور:</strong> ${student.name}<br><strong>الوقت:</strong> ${new Date().toLocaleTimeString()}</div>`;
    } else {
        feedbackEl.innerHTML = `<div class="alert alert-danger"><strong>خطأ:</strong> الطالب غير مسجل.</div>`;
    }
    setTimeout(() => { e.target.value = ''; feedbackEl.innerHTML = ''; e.target.focus(); }, 3000);
}

function startGradesEntry(e) {
    e.preventDefault();
    const groupId = document.getElementById('exam-group').value;
    if (!groupId) { alert('يرجى اختيار مجموعة أولاً.'); return; }

    const studentsInGroup = allStudents.filter(s => s.groupId === groupId);
    const tableBody = document.getElementById('grades-entry-body');
    tableBody.innerHTML = '';
    
    studentsInGroup.forEach(student => {
        tableBody.innerHTML += `<tr><td>${student.name}</td><td><input type="number" class="form-control grade-input" data-student-id="${student.id}" placeholder="ادخل الدرجة"></td></tr>`;
    });
    
    const examName = document.getElementById('exam-name').value;
    document.getElementById('grades-entry-title').innerText = `رصد درجات امتحان "${examName}"`;
    document.getElementById('grades-entry-card').style.display = 'block';
}

function saveGrades() {
    const gradeInputs = document.querySelectorAll('.grade-input');
    const grades = [];
    gradeInputs.forEach(input => {
        if (input.value) {
            grades.push({
                studentId: input.dataset.studentId,
                grade: parseFloat(input.value)
            });
        }
    });

    const data = {
        id: `EXM-${Date.now()}`,
        name: document.getElementById('exam-name').value,
        groupId: document.getElementById('exam-group').value,
        grades: JSON.stringify(grades)
    };

    addData('Exams', data).then(() => {
        alert('تم حفظ الدرجات بنجاح!');
        document.getElementById('grades-entry-card').style.display = 'none';
        document.getElementById('add-exam-form').reset();
    });
}

// ===== APP INITIALIZATION =====
function initializeApp() {
    const navItems = `
        <li class="nav-item"><a class="nav-link active" onclick="showPage('dashboard')"><i class="bi bi-grid-1x2-fill"></i> لوحة التحكم</a></li>
        <li class="nav-item"><a class="nav-link" onclick="showPage('teachers')"><i class="bi bi-person-video3"></i> المدرسون</a></li>
        <li class="nav-item"><a class="nav-link" onclick="showPage('groups')"><i class="bi bi-collection-fill"></i> المجموعات</a></li>
        <li class="nav-item"><a class="nav-link" onclick="showPage('students')"><i class="bi bi-people-fill"></i> الطلاب</a></li>
        <li class="nav-item"><a class="nav-link" onclick="showPage('attendance')"><i class="bi bi-check-circle-fill"></i> الحضور والغياب</a></li>
        <li class="nav-item"><a class="nav-link" onclick="showPage('grades')"><i class="bi bi-pencil-square"></i> الامتحانات والدرجات</a></li>
        <li class="nav-item"><a class="nav-link" onclick="showPage('finance')"><i class="bi bi-cash-stack"></i> الإدارة المالية</a></li>
        <li class="nav-item mt-3"><a class="nav-link text-warning" onclick="logout()"><i class="bi bi-box-arrow-right"></i> تسجيل الخروج</a></li>
    `;
    document.getElementById('desktop-nav-links').innerHTML = navItems;
    document.getElementById('mobile-nav-links').innerHTML = navItems;

    loadAllData();
    showPage('dashboard');

    // Setup event listeners once
    document.getElementById('add-teacher-form').addEventListener('submit', addTeacher);
    document.getElementById('add-group-form').addEventListener('submit', addGroup);
    document.getElementById('add-student-form').addEventListener('submit', addStudent);
    document.getElementById('search-student').addEventListener('keyup', (e) => renderStudentsTable(e.target.value));
    document.getElementById('barcode-input').addEventListener('change', handleAttendance);
    document.getElementById('add-payment-form').addEventListener('submit', addPayment);
    document.getElementById('add-exam-form').addEventListener('submit', startGradesEntry);
    document.getElementById('save-grades-btn').addEventListener('click', saveGrades);
    document.getElementById('attendance-date-filter').addEventListener('change', renderAttendanceLog);
    document.getElementById('view-exam-group-filter').addEventListener('change', populateExamFilter);
    document.getElementById('view-exam-filter').addEventListener('change', renderExamResults);
    document.getElementById('finance-password-form').addEventListener('submit', handleFinanceLogin);
    document.getElementById('show-finances-btn').addEventListener('click', showFinanceDetails);
    document.getElementById('show-daily-revenue-btn').addEventListener('click', showFinanceDetails); // Added listener for new button
    document.getElementById('print-report-btn').addEventListener('click', printTeacherReport);

    // Start finance auth timeout checker
    financeAuthInterval = setInterval(checkFinanceAuthTimeout, 60 * 1000); // Check every minute
}

function printReceipt() {
    const receiptContent = document.getElementById('receipt-modal-content').innerHTML;
    const printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write('<html><head><title>طباعة إيصال</title>');
    printWindow.document.write('<style>body { text-align: center; font-family: "Courier New", monospace; }</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(receiptContent);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
    location.reload();
}

function printTeacherReport() {
    const selectedTeacherName = document.getElementById('report-teacher-select').value;
    const teachersToReport = selectedTeacherName === 'all' 
        ? allTeachers 
        : allTeachers.filter(t => t.name === selectedTeacherName);

    let reportHtml = `
        <html>
        <head>
            <title>تقرير حسابات المدرسين</title>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
            <style>
                body { font-family: 'Tajawal', sans-serif; direction: rtl; }
                @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
                .report-container { max-width: 800px; margin: auto; padding: 2rem; }
                .report-header { text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #dee2e6; padding-bottom: 1rem; }
                .teacher-card { border: 1px solid #dee2e6; border-radius: .5rem; padding: 1.5rem; margin-bottom: 1.5rem; }
                .student-codes { font-size: 0.9rem; color: #6c757d; word-wrap: break-word; }
            </style>
        </head>
        <body>
            <div class="report-container">
                <div class="report-header">
                    <h1>تقرير حسابات المدرسين</h1>
                    <p class="lead">تاريخ التقرير: ${new Date().toLocaleDateString('ar-EG')}</p>
                </div>
    `;

    teachersToReport.forEach(teacher => {
        const teacherGroups = allGroups.filter(g => g.teacherName === teacher.name);
        const teacherGroupIds = teacherGroups.map(g => g.id);
        const teacherStudentIds = allStudents.filter(s => teacherGroupIds.includes(s.groupId)).map(s => s.id);
        const teacherPayments = allPayments.filter(p => teacherStudentIds.includes(p.studentId));
        
        const totalRevenue = teacherPayments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
        const teacherShare = totalRevenue * (parseFloat(teacher.percentage || 0) / 100);

        const payingStudentCodes = teacherPayments
            .map(p => allStudents.find(s => s.id === p.studentId)?.barcode)
            .filter((code, index, self) => code && self.indexOf(code) === index) // Get unique codes
            .join(' - ');

        reportHtml += `
            <div class="teacher-card">
                <h4>${teacher.name}</h4>
                <hr>
                <p><strong>إجمالي الإيرادات:</strong> ${totalRevenue.toFixed(2)} ج</p>
                <p><strong>نسبة المدرس:</strong> ${teacher.percentage || 0}%</p>
                <p><strong>مستحقات المدرس:</strong> ${teacherShare.toFixed(2)} ج</p>
                <hr>
                <p><strong>أكواد الطلاب الذين قاموا بالدفع:</strong></p>
                <p class="student-codes">${payingStudentCodes || 'لا يوجد'}</p>
            </div>
        `;
    });

    reportHtml += `</div></body></html>`;

    const printWindow = window.open('', '', 'height=800,width=1000');
    printWindow.document.write(reportHtml);
    printWindow.document.close();
    printWindow.print();
}


// Initial check
document.addEventListener('DOMContentLoaded', () => {
    financePasswordModal = new bootstrap.Modal(document.getElementById('financePasswordModal'));
    document.getElementById('login-form').addEventListener('submit', handleLogin);
    document.getElementById('test-connection-btn').addEventListener('click', testConnection);
    checkLogin();
});
</script>

</body>
</html>
